#include "kernel/param.h"
#include "kernel/types.h"
#include "kernel/stat.h"
#include "user/user.h"
#include "kernel/fs.h"
#include "kernel/fcntl.h"
#include "kernel/syscall.h"
#include "kernel/memlayout.h"
#include "kernel/riscv.h"

void
overflow1(char *s)
{
  int p2c[2];
  int c2p[2];

  if (pipe(p2c) != 0) exit(-1);
  if (pipe(c2p) != 0) exit(-1);

  int pid = fork();
  if (pid == 0) {
    // in child

    close(p2c[1]); // close write side
    close(0); // close stdin
    dup(p2c[0]); // duplicate read side to stdin

    close(c2p[0]); // close read side
    close(1); // close stdout
    dup(c2p[1]); // duplicate write side to stdout

    char* prog = "overflow1";
    char* argv[2] = {0};
    argv[0] = prog;
    exec(prog, argv);

  } else {
    // in parent
    close(p2c[0]); // close read side
    close(c2p[1]); // close write side

    // write data to pipe
    const char* payload = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n";

    write(p2c[1], payload, 69);
    close(p2c[0]);

    // store stdout of child in buffer;
    char buf[100];
    int buf_size = 0;
    while(1) {
      if (read(c2p[0], buf+buf_size, 1) != 1) break;
      buf_size++;
    }
    wait(&pid);
    if (strcmp(buf, "success") == 0) exit(0);
  }
  exit(-1);
}

// run each test in its own process. run returns 1 if child's exit()
// indicates success.
int
run(void f(char *), char *s) {
  int pid;
  int xstatus;
  
  printf("running test %s\n", s);
  if((pid = fork()) < 0) {
    printf("runtest: fork error\n");
    exit(1);
  }
  if(pid == 0) {
    f(s);
    exit(0);
  } else {
    wait(&xstatus);
    if(xstatus != 0) 
      printf("test %s: FAILED\n", s);
    else
      printf("test %s: OK\n", s);
    return xstatus == 0;
  }
}

int
main(int argc, char *argv[])
{
  char *n = 0;
  if(argc > 1) {
    n = argv[1];
  }
  
  struct test {
    void (*f)(char *);
    char *s;
  } tests[] = {
    { overflow1, "overflow1"},
    { 0, 0},
  };
    
  printf("exploitest starting\n");

  int fail = 0;
  for (struct test *t = tests; t->s != 0; t++) {
    if((n == 0) || strcmp(t->s, n) == 0) {
      if(!run(t->f, t->s))
        fail = 1;
    }
  }
  if(!fail)
    printf("ALL TESTS PASSED\n");
  else
    printf("SOME TESTS FAILED\n");
  exit(1);   // not reached.
}
